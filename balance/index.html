<script>
  // === REQUIRED: your SHA-256 hex here ===
  const PASSWORD_SHA256_HEX = "e0fe87b9ef1bd5b345269890a4f357dd7e531e7bba307ac691567600a049897f";

  // Optional: log computed hash to console on each attempt (set true to debug)
  const DEBUG_LOG_HASH = false;

  // Safe init after DOM exists
  window.addEventListener('DOMContentLoaded', () => {
    const gateEl    = document.getElementById('gate');
    const contentEl = document.getElementById('content');
    const errEl     = document.getElementById('err');
    const pwEl      = document.getElementById('pw');
    const enterBtn  = document.getElementById('enterBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // Warn if hash not configured
    if (!PASSWORD_SHA256_HEX || /^(?:PASTE|YOUR_|)$/i.test(PASSWORD_SHA256_HEX)) {
      errEl.textContent = 'Password gate not configured: set PASSWORD_SHA256_HEX.';
      errEl.style.display = 'block';
    }

    // crypto.subtle requires HTTPS + modern browser
    if (!('crypto' in window) || !('subtle' in crypto)) {
      errEl.textContent = 'Secure crypto not available (need HTTPS / modern browser).';
      errEl.style.display = 'block';
    }

    function showContent() {
      gateEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
    }
    function hideContent() {
      contentEl.classList.add('hidden');
      gateEl.classList.remove('hidden');
    }

    // Persist only for this tab
    const KEY = 'balance_authed';
    if (sessionStorage.getItem(KEY) === '1') showContent();

    async function sha256Hex(str) {
      const enc = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Normalize input a bit: trim whitespace; keep exact case
    function normalizeInput(s) {
      // collapse non-breaking spaces to normal spaces, then trim
      return (s || '').replace(/\u00A0/g, ' ').trim();
    }

    async function tryLogin(ev) {
      if (ev) ev.preventDefault();
      errEl.style.display = 'none';

      const enteredRaw = pwEl.value;
      const entered = normalizeInput(enteredRaw);

      if (!entered) {
        errEl.textContent = 'Please enter a password.';
        errEl.style.display = 'block';
        pwEl.focus();
        return;
      }

      const hash = await sha256Hex(entered);
      if (DEBUG_LOG_HASH) console.log('[balance] computed hash:', hash);

      if (hash === PASSWORD_SHA256_HEX) {
        sessionStorage.setItem(KEY, '1');
        showContent();
      } else {
        errEl.textContent = 'Incorrect password.';
        errEl.style.display = 'block';
        pwEl.select();
      }
    }

    // Ensure button acts as a plain button (not submit)
    enterBtn.setAttribute('type', 'button');
    enterBtn.addEventListener('click', tryLogin);

    // Pressing Enter inside the password field
    pwEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.keyCode === 13) tryLogin(e);
    });

    logoutBtn.addEventListener('click', () => {
      sessionStorage.removeItem(KEY);
      hideContent();
      pwEl.value = '';
      pwEl.focus();
    });
  });

  // --- (unchanged) optional query params to seed balances ---
  const params = new URLSearchParams(location.search);
  if (params.has('csfloat')) document.addEventListener('DOMContentLoaded', ()=> { document.getElementById('b-csfloat').textContent = '$' + params.get('csfloat'); });
  if (params.has('skinport')) document.addEventListener('DOMContentLoaded', ()=> { document.getElementById('b-skinport').textContent = '$' + params.get('skinport'); });
  if (params.has('steam')) document.addEventListener('DOMContentLoaded', ()=> { document.getElementById('b-steam').textContent = '$' + params.get('steam'); });
</script>
